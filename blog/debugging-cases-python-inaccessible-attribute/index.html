<!doctype html><html lang=zh-CN><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon size=180x180 href=https://pagliacii.github.io/silent-lake/images/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://pagliacii.github.io/silent-lake/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://pagliacii.github.io/silent-lake/images/favicon-16x16.png><link rel=manifest href=https://pagliacii.github.io/silent-lake/images/site.webmanifest><link rel=mask-icon href=https://pagliacii.github.io/silent-lake/images/safari-pinned-tab.svg color=#5bbad5><link rel="shortcut icon" href=https://pagliacii.github.io/silent-lake/images/favicon.ico><meta name=msapplication-TileColor content="#da532c"><meta name=msapplication-config content="https://pagliacii.github.io/silent-lake/images/browserconfig.xml"><meta name=theme-color content="#fff"><title>Python 之“无法访问”的属性 | ୧ʕ •ᴥ•ʔ୨ Silent Lake</title><meta name=title content="Python 之“无法访问”的属性"><meta name=description content="最近碰到一个 Python 中的奇怪现象：明明在类定义里有着一个属性，但是在实例化后的对象上却无法访问到它，会抛出 AttributeError。
虽然 root cause 很简单，但是我觉得这个案例可以作为 debug 的例子，于是就有了这篇文章。"><meta name=author content><meta name=keywords content="Python,Debugging Cases,"><meta property="og:title" content="Python 之“无法访问”的属性"><meta property="og:description" content="最近碰到一个 Python 中的奇怪现象：明明在类定义里有着一个属性，但是在实例化后的对象上却无法访问到它，会抛出 AttributeError。
虽然 root cause 很简单，但是我觉得这个案例可以作为 debug 的例子，于是就有了这篇文章。"><meta property="og:type" content="article"><meta property="og:url" content="https://pagliacii.github.io/silent-lake/blog/debugging-cases-python-inaccessible-attribute/"><meta property="og:image" content="https://pagliacii.github.io/silent-lake/images/social_card_bg_hu_3e8922f7ae1ba4a4.webp"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-12-07T22:38:40+08:00"><meta property="article:modified_time" content="2023-12-13T22:11:03+08:00"><meta property="og:site_name" content="Jason's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pagliacii.github.io/silent-lake/images/social_card_bg_hu_3e8922f7ae1ba4a4.webp"><meta name=twitter:title content="Python 之“无法访问”的属性"><meta name=twitter:description content="最近碰到一个 Python 中的奇怪现象：明明在类定义里有着一个属性，但是在实例化后的对象上却无法访问到它，会抛出 AttributeError。
虽然 root cause 很简单，但是我觉得这个案例可以作为 debug 的例子，于是就有了这篇文章。"><meta name=twitter:site content="@PagliaciiH"><meta itemprop=name content="Python 之“无法访问”的属性"><meta itemprop=description content="最近碰到一个 Python 中的奇怪现象：明明在类定义里有着一个属性，但是在实例化后的对象上却无法访问到它，会抛出 AttributeError。
虽然 root cause 很简单，但是我觉得这个案例可以作为 debug 的例子，于是就有了这篇文章。"><meta itemprop=datePublished content="2023-12-07T22:38:40+08:00"><meta itemprop=dateModified content="2023-12-13T22:11:03+08:00"><meta itemprop=wordCount content="680"><meta itemprop=image content="https://pagliacii.github.io/silent-lake/images/social_card_bg_hu_3e8922f7ae1ba4a4.webp"><meta itemprop=keywords content="Python,Debugging Cases,"><meta name=referrer content="no-referrer-when-downgrade"><link href=/silent-lake/original.min.css rel=stylesheet><link href=/silent-lake/syntax.min.css rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.21.2/tocbot.css><link href=/silent-lake/toc.min.css rel=stylesheet></head><body><header><a class=skip-link href=#main-content>Skip to main content</a>
<a href=/silent-lake/ class=title><h1>୧ʕ •ᴥ•ʔ୨ Silent Lake</h1></a><nav><a href=/silent-lake/>Home</a>
<a href=/silent-lake/blog/>Blog</a>
<a href=/silent-lake/tags/>Tags</a>
<a href=https://pagliacii.github.io/silent-lake/index.xml>RSS</a></nav></header><main id=main-content><h1>Python 之“无法访问”的属性</h1><p class=byline style=color:gray;font-size:.9rem>Published:
<time datetime='2023-12-07 22:38:40' pubdate>2023-12-07 22:38:40
</time>| Updated:
<time datetime='2023-12-13 22:11:03'>2023-12-13 22:11:03
</time>|
<span>700</span>
<span>words</span>
|
<span>4</span>
<span>mins</span></p><article class=article><aside class=sidebar><div class=toc-container><div style=font-weight:700;margin-bottom:.4rem>Table of Contents</div><div class=toc></div></div></aside><content class=content><p>最近碰到一个 Python 中的奇怪现象：明明在类定义里有着一个属性，但是在实例化后的对象上却无法访问到它，会抛出 <code>AttributeError</code>。</p><p>虽然 root cause 很简单，但是我觉得这个案例可以作为 debug 的例子，于是就有了这篇文章。</p><h2 id=示例代码>示例代码</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=k>class</span> <span class=nc>Parent</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=n>_fields</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=k>def</span> <span class=fm>__getattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_fields</span><span class=p>[</span><span class=n>name</span><span class=p>]</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>        <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>            <span class=k>raise</span> <span class=ne>AttributeError</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>                <span class=sa>f</span><span class=s2>&#34;&#39;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>&#39; object has no attribute &#39;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl>
</span></span><span class=line><span class=ln>13</span><span class=cl><span class=k>class</span> <span class=nc>Unrelated</span><span class=p>:</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=k>def</span> <span class=nf>name</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>        <span class=k>return</span> <span class=s2>&#34;Unrelated&#34;</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>
</span></span><span class=line><span class=ln>18</span><span class=cl>
</span></span><span class=line><span class=ln>19</span><span class=cl><span class=k>class</span> <span class=nc>Child</span><span class=p>(</span><span class=n>Unrelated</span><span class=p>,</span> <span class=n>Parent</span><span class=p>):</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>    <span class=k>def</span> <span class=nf>name</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>        <span class=c1># access some variable in other module</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>        <span class=k>return</span> <span class=n>OtherModule</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>
</span></span><span class=line><span class=ln>25</span><span class=cl>
</span></span><span class=line><span class=ln>26</span><span class=cl><span class=n>child</span> <span class=o>=</span> <span class=n>Child</span><span class=p>()</span>
</span></span><span class=line><span class=ln>27</span><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;name&#34;</span> <span class=ow>in</span> <span class=nb>dir</span><span class=p>(</span><span class=n>child</span><span class=p>))</span> <span class=c1># True</span>
</span></span><span class=line><span class=ln>28</span><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>child</span><span class=o>.</span><span class=n>name</span><span class=p>)</span> <span class=c1># AttributeError: &#39;Child&#39; object has no attribute &#39;name&#39;</span></span></span></code></pre></div><h2 id=问题描述>问题描述</h2><p>问题出现在访问 <code>Child</code> 实例属性 <code>name</code> 时。虽然 <code>"name" in dir(child)</code> 返回 <code>True</code>，表明属性 <code>name</code> 存在，但是直接访问 <code>child.name</code> 却抛出了 <code>AttributeError</code>。</p><p>这乍一看上去很奇怪，明明属性存在却无法访问，这是为什么呢？</p><h2 id=分析过程>分析过程</h2><p>要分析这个问题，首先我们需要对 Python 中属性查找的过程有一定了解。在 Python 中，当我们使用形如 <code>instance.attribute</code> 来访问实例属性时，会先在该实例对象上查找相应的属性，如果找不到就会抛出 <code>AttributeError</code>。而当我们给类加上了 <code>__getattr__</code> 方法时，Python 就会在找不到属性时调用这个<a href=https://docs.python.org/3/reference/datamodel.html#object.__getattr__>方法</a>。</p><blockquote><p><strong>object.__getattr__(self, name)</strong></p><p>Called when the default attribute access fails with an <a href=https://docs.python.org/3/library/exceptions.html#AttributeError><code>AttributeError</code></a> (either <a href=https://docs.python.org/3/reference/datamodel.html#object.__getattribute__><code>__getattribute__()</code></a> raises an <a href=https://docs.python.org/3/library/exceptions.html#AttributeError><code>AttributeError</code></a> because name is not an instance attribute or an attribute in the class tree for <code>self</code>; or <a href=https://docs.python.org/3/reference/datamodel.html#object.__get__><code>__get__()</code></a> of a name property raises <a href=https://docs.python.org/3/library/exceptions.html#AttributeError><code>AttributeError</code></a>). This method should either return the (computed) attribute value or raise an <a href=https://docs.python.org/3/library/exceptions.html#AttributeError><code>AttributeError</code></a> exception.</p></blockquote><p>当我们执行示例代码中的 <code>print(child.name)</code> 这一行时，会有以下 traceback 信息抛出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=ln> 1</span><span class=cl>---------------------------------------------------------------------------
</span></span><span class=line><span class=ln> 2</span><span class=cl>KeyError                                  Traceback (most recent call last)
</span></span><span class=line><span class=ln> 3</span><span class=cl>Input In [2], in Parent.__getattr__(self, name)
</span></span><span class=line><span class=ln> 4</span><span class=cl>      5 try:
</span></span><span class=line><span class=ln> 5</span><span class=cl>----&gt; 6     return self._fields[name]
</span></span><span class=line><span class=ln> 6</span><span class=cl>      7 except KeyError:
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl>KeyError: &#39;name&#39;
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>During handling of the above exception, another exception occurred:
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl>AttributeError                            Traceback (most recent call last)
</span></span><span class=line><span class=ln>13</span><span class=cl>Input In [4], in &lt;cell line: 0&gt;()
</span></span><span class=line><span class=ln>14</span><span class=cl>----&gt; 1 c.name
</span></span><span class=line><span class=ln>15</span><span class=cl>
</span></span><span class=line><span class=ln>16</span><span class=cl>Input In [2], in Parent.__getattr__(self, name)
</span></span><span class=line><span class=ln>17</span><span class=cl>      6     return self._fields[name]
</span></span><span class=line><span class=ln>18</span><span class=cl>      7 except KeyError:
</span></span><span class=line><span class=ln>19</span><span class=cl>----&gt; 8     raise AttributeError(
</span></span><span class=line><span class=ln>20</span><span class=cl>      9         f&#34;&#39;{self.__class__.__name__}&#39; object has no attribute &#39;{name}&#39;&#34;,
</span></span><span class=line><span class=ln>21</span><span class=cl>     10     )
</span></span><span class=line><span class=ln>22</span><span class=cl>
</span></span><span class=line><span class=ln>23</span><span class=cl>AttributeError: &#39;Child&#39; object has no attribute &#39;name&#39;
</span></span><span class=line><span class=ln>24</span><span class=cl>&gt; &lt;ipython-input-2-b3781a93b20e&gt;(8)__getattr__()
</span></span><span class=line><span class=ln>25</span><span class=cl>      6             return self._fields[name]
</span></span><span class=line><span class=ln>26</span><span class=cl>      7         except KeyError:
</span></span><span class=line><span class=ln>27</span><span class=cl>----&gt; 8             raise AttributeError(
</span></span><span class=line><span class=ln>28</span><span class=cl>      9                 f&#34;&#39;{self.__class__.__name__}&#39; object has no attribute &#39;{name}&#39;&#34;,
</span></span><span class=line><span class=ln>29</span><span class=cl>     10             )</span></span></code></pre></div><p>从 traceback 信息中可以看到，<code>child.name</code> 这一次属性访问调用了父类 <code>Parent</code> 的 <code>__getattr__</code> 方法。但是在子类 <code>Child</code> 的定义中，<code>name</code> 这个属性是明显存在的，它的值是 <code>OtherModule</code> 的 <code>name</code> 属性。由于 <code>__getattr__</code> 只有在属性访问抛出 <code>AttributeError</code> 时才会被调用，那么问题根源应该就是 <code>OtherModule.name</code> 抛出了 <code>AttributeError</code>，才会调用到 <code>__getattr__</code>。</p><p>事实上也是如此，<code>return OtherModule.name</code> 这一行抛出了 <code>AttributeError</code>，属性访问的行为 fallback 到了 <code>__getattr__</code>。</p><h2 id=调试方法>调试方法</h2><p>接下来说一下有什么方法可以用来调试这个问题。调试的目的就是为了弄清楚程序逻辑上有什么问题，通常来说有以下几种方法：</p><ol><li>打断点，使用 <a href=https://docs.python.org/3/library/pdb.html>pdb</a> 进行单步调试</li><li>加<a href=https://docs.python.org/3/howto/logging.html>日志</a>，使用二分法，找到错误的位置</li></ol><h3 id=打断点>打断点</h3><p>打断点就是在程序代码中插入 <code>breakpoint()</code>，当程序执行到这行代码时，程序就会停止运行，可以和当前内存中的数据进行交互，方便定位问题。如果是在 REPL 里，也可以通过 <code>import pdb; pdb.run('your code here')</code> 开始单步调试。</p><p>以 <a href=https://ipython.org/>IPython</a> 为例，进入 REPL 后执行以下代码来进入单步调试：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>1</span><span class=p>]:</span> <span class=kn>import</span> <span class=nn>pdb</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>2</span><span class=p>]:</span> <span class=k>class</span> <span class=nc>OtherModule</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>   <span class=o>...</span><span class=p>:</span>     <span class=k>pass</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>   <span class=o>...</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>   <span class=o>...</span><span class=p>:</span> <span class=c1># Parent/Child class definitions</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>3</span><span class=p>]:</span> <span class=n>c</span> <span class=o>=</span> <span class=n>Child</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>4</span><span class=p>]:</span> <span class=n>pdb</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s1>&#39;c.name&#39;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=ln>11</span><span class=cl><span class=o>&gt;</span> <span class=o>&lt;</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span><span class=p>()</span></span></span></code></pre></div><p>然后输入 <strong>s</strong> 回车来跳进 <code>&lt;module>()</code> 里面，输入 <strong>n</strong> 回车来执行下一行，按 <strong>q</strong> 结束调试。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>4</span><span class=p>]:</span> <span class=n>pdb</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s1>&#39;c.name&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=o>&gt;</span> <span class=o>&lt;</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span><span class=p>()</span>
</span></span><span class="line hl"><span class=ln> 3</span><span class=cl><span class=p>(</span><span class=n>Pdb</span><span class=p>)</span> <span class=n>s</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=o>--</span><span class=n>Call</span><span class=o>--</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=o>&gt;</span> <span class=o>&lt;</span><span class=n>ipython</span><span class=o>-</span><span class=nb>input</span><span class=o>-</span><span class=mi>2</span><span class=o>-</span><span class=mi>20572</span><span class=n>dc1ce97</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>24</span><span class=p>)</span><span class=n>name</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=o>-&gt;</span> <span class=nd>@property</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=p>(</span><span class=n>Pdb</span><span class=p>)</span> <span class=n>n</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=o>&gt;</span> <span class=o>&lt;</span><span class=n>ipython</span><span class=o>-</span><span class=nb>input</span><span class=o>-</span><span class=mi>2</span><span class=o>-</span><span class=mi>20572</span><span class=n>dc1ce97</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>27</span><span class=p>)</span><span class=n>name</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=o>-&gt;</span> <span class=k>return</span> <span class=n>OtherModule</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=p>(</span><span class=n>Pdb</span><span class=p>)</span> <span class=n>n</span>
</span></span><span class="line hl"><span class=ln>11</span><span class=cl><span class=ne>AttributeError</span><span class=p>:</span> <span class=nb>type</span> <span class=nb>object</span> <span class=s1>&#39;OtherModule&#39;</span> <span class=n>has</span> <span class=n>no</span> <span class=n>attribute</span> <span class=s1>&#39;name&#39;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=o>&gt;</span> <span class=o>&lt;</span><span class=n>ipython</span><span class=o>-</span><span class=nb>input</span><span class=o>-</span><span class=mi>2</span><span class=o>-</span><span class=mi>20572</span><span class=n>dc1ce97</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>27</span><span class=p>)</span><span class=n>name</span><span class=p>()</span>
</span></span><span class=line><span class=ln>13</span><span class=cl><span class=o>-&gt;</span> <span class=k>return</span> <span class=n>OtherModule</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=p>(</span><span class=n>Pdb</span><span class=p>)</span> <span class=n>n</span>
</span></span><span class=line><span class=ln>15</span><span class=cl><span class=o>--</span><span class=n>Return</span><span class=o>--</span>
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=o>&gt;</span> <span class=o>&lt;</span><span class=n>ipython</span><span class=o>-</span><span class=nb>input</span><span class=o>-</span><span class=mi>2</span><span class=o>-</span><span class=mi>20572</span><span class=n>dc1ce97</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>27</span><span class=p>)</span><span class=n>name</span><span class=p>()</span><span class=o>-&gt;</span><span class=kc>None</span>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=o>-&gt;</span> <span class=k>return</span> <span class=n>OtherModule</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=ln>18</span><span class=cl><span class=p>(</span><span class=n>Pdb</span><span class=p>)</span>
</span></span><span class=line><span class=ln>19</span><span class=cl><span class=o>--</span><span class=n>Call</span><span class=o>--</span>
</span></span><span class=line><span class=ln>20</span><span class=cl><span class=o>&gt;</span> <span class=o>&lt;</span><span class=n>ipython</span><span class=o>-</span><span class=nb>input</span><span class=o>-</span><span class=mi>2</span><span class=o>-</span><span class=mi>20572</span><span class=n>dc1ce97</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=fm>__getattr__</span><span class=p>()</span>
</span></span><span class="line hl"><span class=ln>21</span><span class=cl><span class=o>-&gt;</span> <span class=k>def</span> <span class=fm>__getattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=ln>22</span><span class=cl><span class=p>(</span><span class=n>Pdb</span><span class=p>)</span>
</span></span><span class=line><span class=ln>23</span><span class=cl><span class=o>&gt;</span> <span class=o>&lt;</span><span class=n>ipython</span><span class=o>-</span><span class=nb>input</span><span class=o>-</span><span class=mi>2</span><span class=o>-</span><span class=mi>20572</span><span class=n>dc1ce97</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>9</span><span class=p>)</span><span class=fm>__getattr__</span><span class=p>()</span>
</span></span><span class=line><span class=ln>24</span><span class=cl><span class=o>-&gt;</span> <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=ln>25</span><span class=cl><span class=p>(</span><span class=n>Pdb</span><span class=p>)</span> <span class=n>q</span></span></span></code></pre></div><p>你也可以在上面第 11 行后输入 <code>p dir(OtherModule)</code> 来查看 <code>OtherModule</code> 对象的属性列表。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=p>(</span><span class=n>Pdb</span><span class=p>)</span> <span class=n>n</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=ne>AttributeError</span><span class=p>:</span> <span class=nb>type</span> <span class=nb>object</span> <span class=s1>&#39;OtherModule&#39;</span> <span class=n>has</span> <span class=n>no</span> <span class=n>attribute</span> <span class=s1>&#39;name&#39;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=o>&gt;</span> <span class=o>&lt;</span><span class=n>ipython</span><span class=o>-</span><span class=nb>input</span><span class=o>-</span><span class=mi>2</span><span class=o>-</span><span class=mi>20572</span><span class=n>dc1ce97</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>27</span><span class=p>)</span><span class=n>name</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=o>-&gt;</span> <span class=k>return</span> <span class=n>OtherModule</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=p>(</span><span class=n>Pdb</span><span class=p>)</span> <span class=n>p</span> <span class=nb>dir</span><span class=p>(</span><span class=n>OtherModule</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=p>[</span><span class=s1>&#39;__class__&#39;</span><span class=p>,</span> <span class=s1>&#39;__delattr__&#39;</span><span class=p>,</span> <span class=s1>&#39;__dict__&#39;</span><span class=p>,</span> <span class=s1>&#39;__dir__&#39;</span><span class=p>,</span> <span class=s1>&#39;__doc__&#39;</span><span class=p>,</span> <span class=s1>&#39;__eq__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=s1>&#39;__format__&#39;</span><span class=p>,</span> <span class=s1>&#39;__ge__&#39;</span><span class=p>,</span> <span class=s1>&#39;__getattribute__&#39;</span><span class=p>,</span> <span class=s1>&#39;__getstate__&#39;</span><span class=p>,</span> <span class=s1>&#39;__gt__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=s1>&#39;__hash__&#39;</span><span class=p>,</span> <span class=s1>&#39;__init__&#39;</span><span class=p>,</span> <span class=s1>&#39;__init_subclass__&#39;</span><span class=p>,</span> <span class=s1>&#39;__le__&#39;</span><span class=p>,</span> <span class=s1>&#39;__lt__&#39;</span><span class=p>,</span> <span class=s1>&#39;__module__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=s1>&#39;__ne__&#39;</span><span class=p>,</span> <span class=s1>&#39;__new__&#39;</span><span class=p>,</span> <span class=s1>&#39;__reduce__&#39;</span><span class=p>,</span> <span class=s1>&#39;__reduce_ex__&#39;</span><span class=p>,</span> <span class=s1>&#39;__repr__&#39;</span><span class=p>,</span> <span class=s1>&#39;__setattr__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=s1>&#39;__sizeof__&#39;</span><span class=p>,</span> <span class=s1>&#39;__str__&#39;</span><span class=p>,</span> <span class=s1>&#39;__subclasshook__&#39;</span><span class=p>,</span> <span class=s1>&#39;__weakref__&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=p>(</span><span class=n>Pdb</span><span class=p>)</span></span></span></code></pre></div><h2 id=用途>用途</h2><p>看到这里你可能想问，<code>__getattr__</code> 这个方法有什么用处？接下来就举个例子，用它来实现 wrapper 类。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=k>class</span> <span class=nc>Wrapped</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=k>def</span> <span class=nf>method1</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Called method1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=k>def</span> <span class=nf>method2</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Called method2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=k>class</span> <span class=nc>Wrapper</span><span class=p>:</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>wrapped</span><span class=p>):</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_wrapped</span> <span class=o>=</span> <span class=n>wrapped</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=k>def</span> <span class=fm>__getattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Calling </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_wrapped</span><span class=p>,</span> <span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>
</span></span><span class=line><span class=ln>17</span><span class=cl>
</span></span><span class=line><span class=ln>18</span><span class=cl><span class=n>w</span> <span class=o>=</span> <span class=n>Wrapper</span><span class=p>(</span><span class=n>Wrapped</span><span class=p>())</span>
</span></span><span class=line><span class=ln>19</span><span class=cl><span class=n>w</span><span class=o>.</span><span class=n>method1</span><span class=p>()</span>
</span></span><span class=line><span class=ln>20</span><span class=cl><span class=c1># Calling method1</span>
</span></span><span class=line><span class=ln>21</span><span class=cl><span class=c1># Called method1</span></span></span></code></pre></div><p>就像这样，可以很方便地在不修改原来对象的情况下实现对原来对象的方法调用的监控，比如可以加上日志，统计调用量或者加上额外处理等。</p><h2 id=bonus>Bonus</h2><p>在 Python <a href=https://docs.python.org/3/reference/datamodel.html>Data Model</a> 文档里还有这样一个 <a href=https://docs.python.org/3/reference/datamodel.html#object.__getattribute__>magic method</a>: <code>__getattribute__</code>。它会在属性访问时无条件调用。</p><blockquote><p><strong>object.__getattribute__(self, name)</strong></p><p>Called unconditionally to implement attribute accesses for instances of the class.</p></blockquote><p>我们知道在 Python 里并没有事实上的私有变量，只有约定上的私有属性。其实借助 <code>__getattribute__</code> 方法，我们就可以把约定上的私有属性变为“事实上”的私有属性。</p><details><summary style=color:var(--flexoki-light-blue)>Bonus</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=k>class</span> <span class=nc>Base</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>public_attr</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_private_attr</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=k>def</span> <span class=fm>__getattribute__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>        <span class=k>if</span> <span class=n>name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;_&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;__&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>            <span class=k>if</span> <span class=nb>type</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=ow>is</span> <span class=ow>not</span> <span class=n>Base</span><span class=p>:</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>                <span class=k>raise</span> <span class=ne>AttributeError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unaccessible private attribute: </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>        <span class=n>val</span> <span class=o>=</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__getattribute__</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>        <span class=k>if</span> <span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;__dict__&#34;</span> <span class=ow>and</span> <span class=nb>type</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=ow>is</span> <span class=ow>not</span> <span class=n>Base</span><span class=p>:</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=n>v</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>val</span><span class=o>.</span><span class=n>items</span><span class=p>()</span> <span class=k>if</span> <span class=ow>not</span> <span class=n>k</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;_&#34;</span><span class=p>)}</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>        <span class=k>return</span> <span class=n>val</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>
</span></span><span class=line><span class=ln>16</span><span class=cl>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=k>class</span> <span class=nc>Sub</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>
</span></span><span class=line><span class=ln>20</span><span class=cl>
</span></span><span class=line><span class=ln>21</span><span class=cl><span class=n>b</span> <span class=o>=</span> <span class=n>Base</span><span class=p>()</span>
</span></span><span class=line><span class=ln>22</span><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>b</span><span class=o>.</span><span class=n>public_attr</span><span class=p>)</span>    <span class=c1># 0</span>
</span></span><span class=line><span class=ln>23</span><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>b</span><span class=o>.</span><span class=n>_private_attr</span><span class=p>)</span>  <span class=c1># 1</span>
</span></span><span class=line><span class=ln>24</span><span class=cl><span class=n>s</span> <span class=o>=</span> <span class=n>Sub</span><span class=p>()</span>
</span></span><span class=line><span class=ln>25</span><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>public_attr</span><span class=p>)</span>    <span class=c1># 0</span>
</span></span><span class=line><span class=ln>26</span><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>_private_attr</span><span class=p>)</span>  <span class=c1># AttributeError: Unaccessible private attribute: _private_attr</span></span></span></code></pre></div></details></content><p><a class=blog-tags href=https://pagliacii.github.io/silent-lake/tags/python/>#Python</a>&nbsp;&nbsp;
<a class=blog-tags href=https://pagliacii.github.io/silent-lake/tags/debugging-cases/>#Debugging Cases</a>&nbsp;&nbsp;</p></article><p style=display:flex;justify-content:space-between;align-items:center;margin-top:1.5rem><a href='mailto:huangmianrui0310@gmail.com?subject=Reply%20to%20"Python%20%e4%b9%8b%e2%80%9c%e6%97%a0%e6%b3%95%e8%ae%bf%e9%97%ae%e2%80%9d%e7%9a%84%e5%b1%9e%e6%80%a7"'>reply via e-mail</a>
<span class=copy-markdown-links><a href=javascript:void(0) onclick=copyMarkdown()>copy as</a> /
<a href=javascript:void(0) onclick=viewMarkdown() rel="noopener noreferrer">view</a>
markdown</span></p><script src=https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js></script><script>addBackToTop({cornerOffset:32,diameter:48,backgroundColor:"var(--flexoki-dark-cyan)",textColor:"var(--flexoki-50)",showWhenScrollTopIs:512})</script><script src=/silent-lake/js/copy-code-button.min.js></script><script src=/silent-lake/js/copy-markdown.min.js></script><link rel=stylesheet href=/silent-lake/css/copy-markdown.min.css><script src=https://giscus.app/client.js data-repo=Pagliacii/silent-lake data-repo-id=R_kgDOKgeurQ data-category=Comments data-category-id=DIC_kwDOKgeurc4CaZsJ data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=https://giscus.catppuccin.com/themes/latte.css data-lang=en data-loading=lazy crossorigin=anonymous async></script></main><footer><small><a href=https://github.com/Pagliacii>Jason Huang</a> © 2025 | Made With <a href=https://github.com/Pagliacii/hugo-bearberry>Bear Berry</a></small></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.21.2/tocbot.min.js></script><script src=/silent-lake/js/toc.min.js></script></body></html>